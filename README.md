# quartz-transformer-mmlabc

A Quartz transformer plugin that converts MML (Music Macro Language) and chord progression notation code blocks into interactive sheet music using abcjs.

*This document is a temporary draft, hastily generated by an LLM. It will be revised in the future.*

## Status
- Implementation is largely complete.
- Currently dogfooding.
- Breaking changes may occur.

## Features

- ðŸŽµ Converts `mml` code blocks to ABC notation and renders them with abcjs.
- ðŸŽ¸ Converts `chord` code blocks to MML, then to ABC notation, and renders them with abcjs.
- ðŸŽ¼ Supports `abc` notation code blocks for troubleshooting or direct use.
- ðŸŽ¨ Automatically renders sheet music as SVG (displays musical staff).
- ðŸŽ§ Click to play music - You can play music by clicking on the rendered sheet music.
- âš¡ Lightweight, standalone npm module.
- ðŸ”§ TypeScript support.

## Installation

Run the following in your Quartz installation directory:

```powershell
npm install github:cat2151/quartz-transformer-mmlabc; pushd node_modules/quartz-transformer-mmlabc; npm run build; popd
```

Why this step is necessary:
- The plugin is installed directly from GitHub (not npm).
- The `dist` directory, containing compiled JavaScript, is not included in the repository.
- Skipping this step will result in an error when running Quartz because the plugin's entry point (`dist/index.js`) will not exist.

Furthermore, add the following before `Build Quartz` in `.github\workflows\deploy.yml`:
```yml
      - name: Build quartz-transformer-mmlabc
        run: npm run build
        working-directory: node_modules/quartz-transformer-mmlabc
```
Why this step is necessary:
- Without this, during GitHub Actions deployment, an error will occur during `Build Quartz` because the plugin's entry point (`dist/index.js`) will not exist.

## Usage

### Usage in Quartz Configuration

Add the transformer to `quartz.config.ts`:

```typescript
import { QuartzConfig } from "./quartz/cfg"
import * as Plugin from "./quartz/plugins"
import { MMLABCTransformer } from "quartz-transformer-mmlabc"

const config: QuartzConfig = {
  configuration: {
    // ... site settings
  },
  plugins: {
    transformers: [
      Plugin.FrontMatter(),
      Plugin.CreatedModifiedDate({ priority: ["frontmatter", "filesystem"] }),
      // Add MMLABC Transformer
      MMLABCTransformer(),
      // ... other transformers
    ],
    filters: [Plugin.RemoveDrafts()],
    emitters: [
      Plugin.AliasRedirects(),
      Plugin.ComponentResources(),
      Plugin.ContentPage(),
      // ... other emitters
    ],
  },
}

export default config
```

**Important Points:**
- Import `QuartzConfig` and built-in plugins from Quartz's internal paths.
- This plugin is imported by its npm package name.
- Add it to the `transformers` array along with other transformers.
- The order usually doesn't matter unless there are dependencies between plugins.

### Usage in Markdown Files

#### MML Notation

````markdown
```mml
t120 l4 cdefgab>c
```
````

#### Chord Progression Notation

````markdown
```chord
C Dm7 G7 C
```
````

#### ABC Notation (Direct Specification)

````markdown
```abc
X:1
T:Simple Scale
M:4/4
L:1/4
K:C
C D E F|G A B c|
```
````

This is useful for troubleshooting or when you want to write ABC notation directly.

## Options

The plugin accepts optional settings:

```typescript
MMLABCTransformer({
  enableMML: true,    // Enable MML block transformation (default: true)
  enableChord: true,  // Enable chord progression block transformation (default: true)
  enableABC: true,    // Enable ABC block transformation (default: true)
})
```

## How it works

1. During Quartz's build process, the plugin detects code blocks with `mml`, `chord`, or `abc` language tags.
2. These code blocks are replaced with HTML div elements containing the source notation as data attributes.
3. In the browser:
   - abcjs and mml2abc are loaded from a CDN.
   - For MML blocks: MML is converted to ABC notation using mml2abc.
   - For chord progression blocks: Chord progression is converted to MML using chord2mml, then to ABC notation.
   - For ABC blocks: The notation is used directly without conversion.
   - abcjs is used to render the ABC notation as an interactive SVG.
   - An audio synthesizer is initialized to support music playback.
   - A click event handler is added to the sheet music, allowing music to be played by clicking.

## Current Status

### Implemented Features
- âœ… MML block detection and transformation.
- âœ… Chord progression block detection and transformation.
- âœ… ABC block detection and direct rendering (useful for troubleshooting).
- âœ… ABC notation rendering using abcjs (displaying the musical staff).
- âœ… CDN dependencies use versions confirmed to work by @cat2151.
- âœ… Interactive audio playback feature (click the sheet music to play the piece from the beginning).
  - Uses abcjs synth API and Web Audio API.
  - Visual feedback during playback (background color change and status display).
  - Automatic stop upon playback completion.
  - Clicking again stops playback.

## Notes

- The conversion to HTML occurs during Quartz's build process.
- The actual sheet music conversion and rendering take place in the browser.
- CDN library versions are specified based on working versions confirmed by @cat2151 with easychord2mml.
- MML to ABC conversion uses mml2abc loaded from CDN.
- Chord progression to MML conversion uses chord2mml loaded from CDN.
- Rendering uses abcjs (latest version 6.x) loaded from CDN.
- Libraries are loaded dynamically to avoid bundling issues.

## Testing

The plugin includes a comprehensive automated test suite using Vitest:

### Running Tests

```bash
# Run tests once
npm test

# Run tests in watch mode
npm run test:watch

# Run tests in UI
npm run test:ui
```

### Test Coverage

The test suite includes:
- Unit tests for AST transformation logic.
- HTML escaping tests (newlines, tabs, special characters).
- Plugin options and configuration tests.
- Edge case handling.
- External resource validation.

For manual testing, please use the included `demo.html` file.

**Note**: When the Coding Agent performs tests on a Linux Runner, the CDN may be blocked, preventing the display of musical notation. If you want to check the display of musical notation, please test it on a physical machine (local environment).

## Dependencies

### Runtime (loaded via CDN)

**Important**: The following library versions are strongly specified based on working versions confirmed by @cat2151 with [easychord2mml](https://github.com/cat2151/easychord2mml/blob/main/index.html). Do not change these URLs.

- [abcjs](https://github.com/paulrosen/abcjs) - JavaScript library for rendering ABC musical notation
  - CDN: `https://cdn.jsdelivr.net/npm/abcjs@6/dist/abcjs-basic-min.min.js`
- [mml2abc](https://github.com/cat2151/mml2abc) - Converts Music Macro Language to ABC notation
  - CDN: `https://cdn.jsdelivr.net/gh/cat2151/mml2abc/dist/mml2abc.mjs`
- [chord2mml](https://github.com/cat2151/chord2mml) - Converts chord progression notation to MML
  - CDN: `https://cdn.jsdelivr.net/gh/cat2151/chord2mml/dist/chord2mml.js`

### Build-time
- [unified](https://github.com/unifiedjs/unified) - An interface for parsing and transforming content
- [unist-util-visit](https://github.com/syntax-tree/unist-util-visit) - Utility for traversing Unist trees

## Development

### Build

```bash
npm run build
```

### Project Structure

```
quartz-transformer-mmlabc/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ index.ts          # Main plugin implementation
â”œâ”€â”€ dist/                 # Compiled output (generated)
â”‚   â”œâ”€â”€ index.js
â”‚   â””â”€â”€ index.d.ts
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ README.md
```

## License

MIT

## Related Projects

- [Quartz](https://quartz.jzhao.xyz/) - A fast, battery-included static site generator
- [abcjs](https://www.abcjs.net/) - JavaScript for rendering ABC musical notation
- [mml2abc](https://cat2151.github.io/mml2abc/) - MML to ABC converter
- [chord2mml](https://cat2151.github.io/chord2mml/) - Chord progression notation to MML converter