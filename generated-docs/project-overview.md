Last updated: 2026-01-07

# Project Overview

## プロジェクト概要
- Obsidianでコード進行をコードブロックに書くと、五線譜を表示し、クリック演奏も可能にするQuartzトランスフォーマープラグインです。
- Quartz4に対応するため、Obsidian版の機能を移植・拡張した新しいトランスフォーマープラグインとして開発されました。
- MML（Music Macro Language）とABC Notationにも対応しており、幅広い音楽記法をウェブサイトで手軽に利用できます。

## 技術スタック
- フロントエンド:
    - **abcjs**: ABC音楽記法をSVG形式でレンダリングし、クリックによる楽曲再生機能を提供するJavaScriptライブラリです。クライアントサイドで動的に読み込まれ、インタラクティブな楽譜表示を実現します。
    - **mml2abc**: Music Macro Language (MML) で記述された音楽データをABC記法に変換するためのJavaScriptライブラリです。これもブラウザで動的に動作します。
    - **chord2mml**: コード進行（例: C Dm7 G7 C）をMusic Macro Language (MML) に変換するためのJavaScriptライブラリで、ABC記法への変換の中間ステップとして利用されます。ブラウザで動的に読み込まれます。
- 音楽・オーディオ:
    - **abcjs**: 楽譜の視覚化に加え、内蔵のオーディオシンセサイザーを用いてレンダリングされた楽譜の再生機能を提供します。
    - **mml2abc**: MML形式の音楽データを標準的なABC記法に変換することで、音楽情報を統一的に扱えるようにします。
    - **chord2mml**: ユーザーが直感的に記述したコード進行を、プログラムが処理しやすいMML形式に変換する役割を担います。
- 開発ツール:
    - **unified**: コンテンツの抽象構文木（AST）を解析し、変換するためのインターフェースを提供するライブラリで、QuartzプラグインがMarkdownコンテンツを操作する際に利用されます。
    - **unist-util-visit**: `unified`が生成する構文木を効率的に走査し、特定のノード（この場合はコードブロック）を検出するために使用されるユーティリティです。
    - **TypeScript**: 静的型付けを導入することで、大規模なJavaScriptアプリケーション開発におけるコードの品質、保守性、可読性を向上させるプログラミング言語です。
    - **Vitest**: 高速なユニットテストフレームワークで、主にプラグインのAST変換ロジックやコア機能の検証に使用されます。
    - **Playwright**: 最新のウェブブラウザを自動化するためのライブラリで、ブラウザでの楽譜レンダリングやインタラクティブ機能のインテグレーションテストに使用されます。
- テスト:
    - **Vitest**: プラグインの各コンポーネントやロジックが意図通りに機能するかを検証するためのユニットテストを実行します。
    - **@playwright/test**: 実際のブラウザ環境でプラグインが正しく動作し、ユーザーインタラクションに対応しているかを確認するためのインテグレーションテストを実行します。
- ビルドツール:
    - **npm**: Node.jsのパッケージマネージャーで、プロジェクトの依存関係の管理、スクリプトの実行（ビルド、テストなど）、プラグインのインストールに使用されます。
    - **TypeScriptコンパイラ**: `npm run build`コマンドを通じてTypeScriptコードをJavaScriptに変換し、配布可能な形式のプラグインを生成します。
- 言語機能:
    - **ESモジュール (ESM)**: `mml2abc`ライブラリはESM形式で提供され、動的なインポートを通じてモダンなJavaScript環境で効率的にロードされます。
    - **UMD (Universal Module Definition)**: `chord2mml`ライブラリはUMD形式でバンドルされており、CommonJS、AMD、グローバル変数など、様々なJavaScript環境で利用できるよう設計されています。
- 自動化・CI/CD:
    - **GitHub Actions**: プロジェクトのビルド、テスト、デプロイなどのワークフローを自動化するためのCI/CDプラットフォームです。プラグインの自動ビルドがGitHub Actionsのデプロイプロセスに組み込まれています。

## ファイル階層ツリー
```
quartz-transformer-mmlabc/
├── src/
│   ├── index.ts          # メインプラグイン実装
│   └── index.test.ts     # ユニットテスト
├── test/
│   └── integration.test.ts # インテグレーションテスト
├── dist/                 # コンパイル出力（生成）
│   ├── index.js
│   └── index.d.ts
├── demo.html             # 手動テスト用デモファイル
├── package.json
├── tsconfig.json
├── vitest.config.ts      # Vitestテスト設定
├── playwright.config.ts  # Playwrightテスト設定
└── README.md
```

## ファイル詳細説明
- **`.gitignore`**: Gitによるバージョン管理から除外するファイルやディレクトリを指定する設定ファイルです。
- **`LICENSE`**: プロジェクトのライセンス情報（MIT License）が記載されています。
- **`README.ja.md`**: プロジェクトの目的、機能、インストール方法、使い方、開発に関する情報などを日本語で詳細に説明するドキュメントです。
- **`README.md`**: `README.ja.md`の英語版であり、国際的なユーザー向けにプロジェクトの概要や利用方法を提供します。
- **`demo.html`**: プラグインが生成する楽譜のレンダリングや音楽再生機能を、ブラウザで手動テストするために使用されるデモンストレーション用HTMLファイルです。
- **`example.md`**: プラグインがサポートするMML、コード進行、ABC記法それぞれのコードブロックの記述例を示すMarkdownファイルです。
- **`generated-docs/`**: GitHub Actionsなどによって自動生成されたドキュメントを格納するためのディレクトリです。
- **`issue-notes/`**: 開発中に発生した課題、バグ、調査内容、解決策などに関するメモやドキュメントを管理するためのディレクトリです（例: `19.md`, `21.md`など）。
- **`package-lock.json`**: プロジェクトの依存関係ツリーの厳密なバージョンと構造を記録し、再現可能なビルドを保証するためのファイルです。
- **`package.json`**: プロジェクトのメタデータ（名前、バージョン、説明など）、スクリプト定義（ビルド、テストなど）、およびプロジェクトの依存関係（`dependencies`と`devDependencies`）を定義するファイルです。
- **`playwright.config.ts`**: Playwrightテストフレームワークの動作を設定するためのTypeScript設定ファイルです。テスト環境、ブラウザの指定、レポート形式などが含まれます。
- **`src/index.test.ts`**: プラグインのコアロジック（`src/index.ts`）に対して、その内部動作や変換ロジックが正しく機能するかを検証するためのユニットテストコードが記述されています。
- **`src/index.ts`**: このQuartzトランスフォーマープラグインの主要な実装ファイルです。Markdown内の特定のコードブロック（`mml`, `chord`, `abc`）を検出し、それらをHTMLに変換するロジック、およびクライアントサイドで楽譜のレンダリングと再生を処理するためのJavaScriptを注入する機能を担当します。
- **`test/README.md`**: `test`ディレクトリの内容やテストに関する一般的な情報、ガイドラインなどを説明するためのドキュメントです。
- **`test/integration-test.html`**: Playwrightによるインテグレーションテストで使用される特別なHTMLファイルです。テスト中にこのファイルをロードし、ブラウザ上でのプラグインの動作を検証します。
- **`test/integration.test.ts`**: プラグインが実際のウェブページ上で正しく機能し、視覚的な出力やインタラクティブな要素（クリック再生など）が期待通りに動作するかを確認するためのインテグレーションテストコードです。
- **`tsconfig.json`**: TypeScriptコンパイラの設定ファイルです。コンパイルオプション（ターゲットECMAScriptバージョン、モジュール解決戦略、出力ディレクトリなど）が定義されています。
- **`vitest.config.ts`**: Vitestテストフレームワークの動作を設定するためのTypeScript設定ファイルです。テストの検出方法、カバレッジレポートの設定などが含まれます。

## 関数詳細説明
- **`escapeHtml`** (`src/index.ts`):
    - 役割: HTMLの特殊文字（`<`, `>`, `&`, `"`, `'`）を対応するHTMLエンティティに変換し、クロスサイトスクリプティング（XSS）攻撃などのセキュリティリスクを防ぎ、文字列がHTMLコンテンツとして安全に表示されるようにします。
    - 引数: `text: string`（エスケープする文字列）。
    - 戻り値: `string`（エスケープされた文字列）。
    - 機能: 与えられた文字列内のHTML特殊文字を、対応するエスケープシーケンスに置換します。
- **`waitForABCJS`** (`src/index.ts`):
    - 役割: クライアントサイドで動的にロードされる`abcjs`ライブラリが完全に利用可能になるまで待機します。これにより、ライブラリの準備が整う前に機能が呼び出されるのを防ぎます。
    - 引数: なし。
    - 戻り値: `Promise<void>`。
    - 機能: `abcjs`がグローバルスコープで利用可能になるのをポーリングなどの方法で監視し、準備完了時に解決するPromiseを返します。
- **`checkABCJS`** (`src/index.ts`):
    - 役割: `abcjs`ライブラリが既にブラウザ環境にロードされ、利用可能であるかをチェックします。
    - 引数: なし。
    - 戻り値: `boolean`（`abcjs`が利用可能であれば`true`、そうでなければ`false`）。
    - 機能: グローバルオブジェクト（例: `window.ABCJS`）の存在を確認し、`abcjs`オブジェクトへの参照を提供します。
- **`updateNotationTheme`** (`src/index.ts`):
    - 役割: 楽譜の表示テーマを、Quartzサイトの現在のテーマ設定（ライトモード/ダークモードなど）に合わせて動的に更新します。
    - 引数: なし。
    - 戻り値: なし。
    - 機能: `getQuartzTheme`からテーマ情報を取得し、`abcjs`のレンダリングオプションに適用して、楽譜の見た目をサイト全体と調和させます。
- **`getQuartzTheme`** (`src/index.ts`):
    - 役割: 現在適用されているQuartzサイトのテーマ（例: 'light', 'dark'）に関する情報を取得します。
    - 引数: なし。
    - 戻り値: `string`または`object`（テーマに関する情報）。
    - 機能: DOM要素のクラス名やCSS変数などを参照して、現在のテーマ設定を判別します。
- **`handlePlayback`** (`src/index.ts`):
    - 役割: レンダリングされた楽譜をクリックした際のイベントを処理し、楽曲の再生または一時停止を制御します。
    - 引数: `event: MouseEvent`（クリックイベントオブジェクト）。
    - 戻り値: なし。
    - 機能: クリックされた楽譜に対応する音楽データを取得し、`abcjs`のオーディオシンセサイザーを使用して再生を開始したり、既に再生中の場合は停止したりします。キーボードアクセシビリティもサポートします。
- **`cleanup`** (`src/index.ts`):
    - 役割: プラグインによって追加されたイベントリスナーやリソースを解放し、メモリリークを防ぎ、ページのクリーンな状態を保ちます。
    - 引数: なし。
    - 戻り値: なし。
    - 機能: `addEventListener`で追加されたハンドラーを`removeEventListener`で削除するなど、関連するリソースの後処理を行います。
- **`checkPlaybackStatus`** (`src/index.ts`):
    - 役割: 現在の楽曲再生の状態（再生中であるか否か）を確認し、その状態に応じてUI要素を更新するなどの処理を行います。
    - 引数: なし。
    - 戻り値: `boolean`（再生中であれば`true`、そうでなければ`false`）。
    - 機能: `abcjs`のオーディオシンセサイザーの状態を参照して、再生状況を判断します。
- **`markdownPlugins`** (`src/index.ts`):
    - 役割: QuartzのMarkdown処理パイプラインに、MML/Chord/ABCコードブロックの変換ロジックを組み込むための主要なエントリポイントとして機能します。
    - 引数: なし。
    - 戻り値: `Array<Plugin>`（Quartzが認識するプラグインの配列）。
    - 機能: `unified`と`unist-util-visit`を使用してMarkdownの構文木を走査し、対応するコードブロックを検出してHTMLのdiv要素に変換します。
- **`if`** (`src/index.ts`, `test/integration.test.ts`):
    - 役割: プログラムの流れを制御する条件分岐の構文です。特定の条件が真である場合にのみ、コードのブロックを実行します。
    - 引数: なし（一般的な構文のため）。
    - 戻り値: なし（一般的な構文のため）。
    - 機能: 条件に応じて異なる処理パスを選択するロジックを実装します。
- **`externalResources`** (`src/index.ts`):
    - 役割: プラグインがクライアントサイドで動的に読み込む外部ライブラリ（`abcjs`, `mml2abc`, `chord2mml`）のURLや関連するセキュリティ情報（SRIチェックサム）を定義します。
    - 引数: なし。
    - 戻り値: `Array<Resource>`（外部リソースのメタデータを含むオブジェクトの配列）。
    - 機能: これらの定義に基づいて、HTMLに外部スクリプトタグを注入し、ブラウザでのロードをトリガーします。
- **`blocks`** (`src/index.ts`):
    - 役割: Markdown内のコードブロック（`mml`, `chord`, `abc`）を識別し、その内容と種類に応じた処理を施すためのロジックをカプセル化します。
    - 引数: なし。
    - 戻り値: なし。
    - 機能: `unist-util-visit`を用いてコードブロックノードを見つけ、それらをHTML要素に変換し、後のクライアントサイド処理のためにデータ属性を付与します。
- **`function`** (`src/index.ts`):
    - 役割: JavaScriptにおける匿名関数や、高階関数内で定義される関数、またはオブジェクトのメソッドなど、特定の処理をまとめたコードブロックを指します。
    - 引数: なし（文脈による）。
    - 戻り値: なし（文脈による）。
    - 機能: コードの再利用性、モジュール性、イベントハンドリングなどを実現します。
- **`catch`** (`src/index.ts`):
    - 役割: `try...catch`文の一部として、`try`ブロック内で発生した例外（エラー）を捕捉し、エラーハンドリングロジックを実行します。
    - 引数: `error: Error`（捕捉されたエラーオブジェクト）。
    - 戻り値: なし。
    - 機能: エラー発生時にプログラムが予期せず終了するのを防ぎ、適切なエラーメッセージの表示や代替処理を実行します。
- **`forEach`** (`src/index.ts`):
    - 役割: 配列やリストの各要素に対して、指定された関数（コールバック関数）を一度ずつ実行するイテレータメソッドです。
    - 引数: `callback: Function`（各要素に適用する関数）。
    - 戻り値: なし。
    - 機能: コレクション内のすべての項目を順に処理する際に使用されます。
- **`for`** (`src/index.ts`):
    - 役割: プログラム内で繰り返し処理を実行するための基本的なループ構文です。特定の条件が満たされる間、コードブロックを繰り返し実行します。
    - 引数: なし（一般的な構文のため）。
    - 戻り値: なし（一般的な構文のため）。
    - 機能: 固定回数の反復や、配列・オブジェクトの要素を走査する際などに使用されます。
- **`addEventListener`** (`src/index.ts`):
    - 役割: 指定されたDOM要素にイベントリスナー（イベントハンドラ関数）を登録します。これにより、特定のイベント（例: `click`, `DOMContentLoaded`）が発生したときに、登録された関数が実行されます。
    - 引数: `eventType: string`（イベントの種類）、`listener: Function`（イベント発生時に実行する関数）。
    - 戻り値: なし。
    - 機能: ユーザーインタラクションやシステムイベントに対応して、動的な動作を実現します。
- **`media`** (`src/index.ts`):
    - 役割: メディア関連の処理や定義を含む部分を指す可能性があります。例えば、CSSのメディアクエリ関連のロジック、またはオーディオ再生に関する設定の一部かもしれません。
    - 引数: なし（文脈による）。
    - 戻り値: なし（文脈による）。
    - 機能: スクリーンサイズやデバイス特性に応じた表示の調整、またはオーディオシンセサイザーの初期設定などに関連する場合があります。

## 関数呼び出し階層ツリー
```
- checkPlaybackStatus (src/index.ts)
  - escapeHtml (src/index.ts)
    - waitForABCJS ()
      - checkABCJS ()
      - updateNotationTheme ()
      - getQuartzTheme ()
      - handlePlayback ()
      - cleanup ()
      - markdownPlugins ()
      - externalResources ()
      - function ()
      - forEach ()
      - addEventListener ()
- if (src/index.ts)
- blocks (src/index.ts)
- catch (src/index.ts)
- for (src/index.ts)
- media (src/index.ts)

---
Generated at: 2026-01-07 07:02:24 JST
