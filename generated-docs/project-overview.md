Last updated: 2026-01-04

# Project Overview

## プロジェクト概要
- MMLやコード進行記法のコードブロックを、インタラクティブな楽譜に変換するQuartzプラグインです。
- abcjsライブラリを使用して楽譜をSVGとしてレンダリングし、クリックで楽曲を再生する機能を提供します。
- 静的サイトジェネレーターQuartzに統合され、ユーザーが音楽コンテンツを簡単に埋め込めるようにします。

## 技術スタック
- フロントエンド:
    - **abcjs**: ABC音楽記法をブラウザ上でインタラクティブなSVG楽譜としてレンダリングし、Web Audio APIによる楽曲再生機能を提供します。CDN経由で動的に読み込まれます。
    - **mml2abc**: Music Macro Language (MML) をABC記法に変換するためのライブラリです。CDN経由でブラウザ上で動的に読み込まれます。
    - **chord2mml**: コード進行記法をMMLに変換するためのライブラリです。CDN経由でブラウザ上で動的に読み込まれます。
- 音楽・オーディオ:
    - **abcjs**: 楽譜の描画だけでなく、内蔵のシンセサイザーとWeb Audio APIを活用して楽曲のインタラクティブな再生を可能にします。
    - **Web Audio API**: ブラウザ内で高度な音声処理や再生を行うためのJavaScript APIです。abcjsのシンセサイザーの基盤として利用されます。
- 開発ツール:
    - **npm / yarn**: JavaScriptパッケージの管理とプロジェクトのビルド、テストスクリプトの実行に使用されます。
    - **GitHub**: プラグインのソースコードホスティングとバージョン管理、および直接インストール元として利用されます。
    - **Playwright**: ブラウザ自動化ライブラリで、プラグインのE2E（エンドツーエンド）統合テストに使用されます。
- テスト:
    - **Vitest**: 高速なユニットテストおよび統合テストフレームワークです。プラグインのAST変換ロジックなどのテストに利用されます。
    - **@vitest/ui**: Vitestのテスト結果をブラウザで視覚的に確認するためのUIを提供します。
    - **@playwright/test**: Playwrightをテストフレームワークとして利用するためのツールで、ブラウザ上での実際のレンダリングや再生機能のテストに使用されます。
- ビルドツール:
    - **TypeScript**: 静的型付けを可能にするJavaScriptのスーパーセットで、プラグインの開発言語として採用されています。
    - **tsc**: TypeScriptコンパイラで、TypeScriptソースコードをJavaScriptに変換し、`dist`ディレクトリを生成します。
    - **unified**: コンテンツの解析と変換のためのインターフェースを提供するライブラリで、Markdown ASTの処理に使用されます。
    - **unist-util-visit**: `unified`エコシステムの一部で、構文木（AST）を走査するためのユーティリティを提供します。
- 言語機能:
    - **TypeScript**: 最新のECMAScript機能に加え、型安全性を提供し、大規模なプロジェクトの開発を支援します。
- 開発標準:
    - **tsconfig.json**: TypeScriptコンパイラの設定を定義し、プロジェクト全体のコード品質と一貫性を維持するためのルールを設定します。

## ファイル階層ツリー
```
quartz-transformer-mmlabc/
├── src/
│   └── index.ts          # メインプラグイン実装
├── dist/                 # コンパイル出力（生成）
│   ├── index.js
│   └── index.d.ts
├── package.json
├── tsconfig.json
└── README.md
```

## ファイル詳細説明
-   **`.gitignore`**: Gitによるバージョン管理から除外すべきファイルやディレクトリ（例: ビルド成果物、依存関係モジュール）を指定します。
-   **`LICENSE`**: プロジェクトのライセンス情報（MITライセンス）を記載しています。
-   **`README.ja.md`**: プロジェクトの日本語版説明書です。プラグインの機能、インストール方法、使用方法などが記載されています。
-   **`README.md`**: プロジェクトの英語版説明書です。`README.ja.md`と同様の内容が英語で提供されています。
-   **`_config.yml`**: Quartz静的サイトジェネレーターの構成ファイルです。プラグインとは直接関係ない可能性もありますが、プロジェクト内で利用される可能性があります。
-   **`demo.html`**: プラグインが変換・レンダリングした楽譜や再生機能を、ブラウザで手動テストするためのデモンストレーション用HTMLファイルです。
-   **`example.md`**: MML、コード進行、ABC記法それぞれのコードブロックの記述例を示すMarkdownファイルです。
-   **`generated-docs/`**: プロジェクトによって生成されるドキュメントや成果物が格納されるディレクトリ（推測）。
-   **`issue-notes/19.md`** から **`issue-notes/26.md`**: 開発中に発生した問題、検討事項、修正履歴などを記録するためのMarkdownファイル群です。
-   **`package-lock.json`**: `npm install`コマンドによって生成され、プロジェクトの依存関係ツリーの正確なバージョンとハッシュを記録します。これにより、環境間での一貫した依存関係が保証されます。
-   **`package.json`**: プロジェクトのメタデータ（名前、バージョン、説明など）、スクリプト（ビルド、テストなど）、および開発時・実行時の依存関係が定義されています。
-   **`playwright.config.ts`**: Playwrightテストフレームワークの設定ファイルです。テスト実行時のブラウザ、並列処理、タイムアウトなどを定義します。
-   **`src/`**: プラグインのソースコードを格納するディレクトリです。
    -   **`src/index.test.ts`**: メインプラグイン（`src/index.ts`）のユニットテストを記述したファイルです。AST変換ロジックやオプションの動作検証が含まれます。
    -   **`src/index.ts`**: Quartzトランスフォーマープラグインのメイン実装ファイルです。Markdown内のMML、chord、abcコードブロックを検出し、それらをHTMLのdiv要素に変換し、ブラウザ側で楽譜をレンダリング・再生するためのJavaScriptコードを注入します。
-   **`dist/`**: TypeScriptソースコードをコンパイルしたJavaScriptファイルと型定義ファイルが出力されるディレクトリです。
    -   **`dist/index.js`**: `src/index.ts`がTypeScriptコンパイラによってJavaScriptに変換された、実行可能なプラグインコードです。
    -   **`dist/index.d.ts`**: `src/index.ts`から生成されるTypeScriptの型定義ファイルで、このプラグインをTypeScriptプロジェクトで利用する際に型情報を提供します。
-   **`test/`**: プラグインのテスト関連ファイルを格納するディレクトリです。
    -   **`test/README.md`**: テストディレクトリに関する説明が記載されている可能性があります。
    -   **`test/integration-test.html`**: Playwrightによる統合テストで使用される、実際のブラウザ環境での動作確認用のHTMLファイルです。
    -   **`test/integration.test.ts`**: Playwrightを使用した統合テストを記述したファイルです。ブラウザ上で楽譜が正しくレンダリングされ、再生機能が動作するかなどを検証します。
-   **`tsconfig.json`**: TypeScriptコンパイラの設定ファイルです。ターゲットとするECMAScriptバージョン、モジュール解決方法、型チェックの厳格さなどが定義されています。
-   **`vitest.config.ts`**: Vitestテストフレームワークの設定ファイルです。テスト環境、モックの設定、テストカバレッジの収集方法などを定義します。

## 関数詳細説明
-   **`checkPlaybackStatus` (src/index.ts)**:
    -   役割: 現在の楽譜の再生状態（再生中か停止中か）を確認し、それに応じた処理を実行します。
    -   引数: 不明（おそらく楽譜要素のIDや状態を渡す）
    -   戻り値: 不明（再生状態を示すブール値やオブジェクト）
    -   機能: 楽譜の再生中/停止中の視覚的フィードバック（背景色の変更やステータス表示）を管理する上で、現在の状態を判断するために使用されます。
-   **`escapeHtml` (src/index.ts)**:
    -   役割: HTML特殊文字（`<`, `>`, `&`, `"`, `'`など）をエスケープし、安全なHTML文字列を生成します。
    -   引数: `text: string`（エスケープする文字列）
    -   戻り値: `string`（エスケープされた文字列）
    -   機能: ユーザーが入力したMMLなどの記法をHTML要素のデータ属性に安全に埋め込むために使用され、XSS（クロスサイトスクリプティング）攻撃を防ぎます。
-   **`handlePlayback` (src/index.ts)**:
    -   役割: レンダリングされた楽譜のクリックイベントに応答し、音楽の再生開始または停止を処理します。
    -   引数: 不明（おそらくイベントオブジェクトや楽譜のデータ）
    -   戻り値: `void`
    -   機能: abcjsのシンセサイザーAPIとWeb Audio APIを使用して、クリックされた楽譜に対応する楽曲を再生または停止させ、再生中の視覚的フィードバックを更新します。
-   **`cleanup` (src/index.ts)**:
    -   役割: 楽曲再生が完了した際、または再生が停止された際に、関連するオーディオリソースや視覚的フィードバックをクリーンアップします。
    -   引数: 不明
    -   戻り値: `void`
    -   機能: 再生が終了した楽譜の背景色を元に戻したり、シンセサイザーを解放したりするなど、不要になったリソースを適切に処理します。
-   **`markdownPlugins` (src/index.ts)**:
    -   役割: Quartzのビルドプロセス中にMarkdownの抽象構文木（AST）を走査し、特定のコードブロック（`mml`, `chord`, `abc`）を検出して変換するためのunifiedプラグインの集まりです。
    -   引数: 不明
    -   戻り値: unifiedプラグインの配列
    -   機能: MML、chord、ABC記法のコードブロックを、ブラウザ側でレンダリングするために必要なHTML `div`要素に置き換えます。
-   **`if` (src/index.ts)**:
    -   役割: 条件分岐ロジックの一部として、特定の条件が真の場合にのみコードブロックを実行します。
    -   引数: 不明（条件式）
    -   戻り値: `void`（または条件付きで値を返す）
    -   機能: プラグインのオプション設定（`enableMML`, `enableChord`, `enableABC`）に基づいて、どの記法を処理するかを決定したり、特定の状態でのみ再生ロジックを実行したりする際に利用されます。
-   **`externalResources` (src/index.ts)**:
    -   役割: abcjs、mml2abc、chord2mmlといった外部のJavaScriptライブラリをCDNから動的に読み込むロジックをカプセル化します。
    -   引数: 不明
    -   戻り値: 不明（読み込みが完了したPromiseなど）
    -   機能: バンドルサイズの問題を避け、必要なときにのみライブラリをロードすることで、プラグインの軽量性を保ちます。
-   **`blocks` (src/index.ts)**:
    -   役割: Markdown AST内で特定の言語タグを持つコードブロック（`mml`, `chord`, `abc`）を識別し、処理するために使用されます。
    -   引数: 不明（ASTノードや訪問関数）
    -   戻り値: `void`
    -   機能: `unist-util-visit`などのユーティリティと組み合わせて、対象となるコードブロックを効率的に見つけ出します。
-   **`for` (src/index.ts)**:
    -   役割: ループ処理を実行する部分。配列やリストの要素を順番に処理したり、特定の回数だけ処理を繰り返したりします。
    -   引数: 不明（ループ変数、イテラブルなど）
    -   戻り値: `void`
    -   機能: 検出された複数のコードブロックを一つずつ処理したり、DOM要素のコレクションに対して操作を行ったりする際に使われます。
-   **`function` (src/index.ts)**:
    -   役割: 匿名関数やコールバック関数、または特定のスコープ内で定義されるヘルパー関数を指します。
    -   引数: 不明（文脈による）
    -   戻り値: 不明（文脈による）
    -   機能: イベントハンドラー、Promiseの解決/拒否コールバック、ユーティリティ関数など、様々な状況で利用されます。
-   **`catch` (src/index.ts)**:
    -   役割: `try-catch`ブロックの一部として、`try`ブロック内で発生した例外（エラー）を捕捉し、適切なエラーハンドリングを実行します。
    -   引数: `error: any`（捕捉されたエラーオブジェクト）
    -   戻り値: `void`
    -   機能: 外部ライブラリの読み込み失敗、変換処理中のエラー、DOM操作エラーなどが発生した場合に、アプリケーションがクラッシュするのを防ぎ、エラーメッセージをログ出力するなどの対応を行います。
-   **`addEventListener` (src/index.ts)**:
    -   役割: DOM要素に特定のイベント（例: `click`）のイベントリスナーを登録します。
    -   引数: `event: string`, `handler: Function`（イベント名とイベントハンドラ関数）
    -   戻り値: `void`
    -   機能: レンダリングされた楽譜のSVG要素に対してクリックイベントリスナーを追加し、ユーザーが楽譜をクリックしたときに`handlePlayback`などの関数を呼び出すように設定します。
-   **`media` (src/index.ts)**:
    -   役割: メディア（この場合は音楽再生）に関連する処理や設定を指す可能性があります。
    -   引数: 不明
    -   戻り値: 不明
    -   機能: Web Audio APIやabcjsのシンセサイザーを通じて、音源のロード、再生、停止、音量調整など、音楽再生に関わる低レベルな操作を行う部分を抽象化している可能性があります。
-   **`if` (test/integration.test.ts)**:
    -   役割: 統合テストコード内で条件分岐を行い、特定のテストケースを実行するかどうかを決定したり、期待される結果をアサートする条件を定義したりします。
    -   引数: 不明（テスト条件式）
    -   戻り値: `void`
    -   機能: テスト環境固有の条件（例: CDNが利用可能か）や、特定のシナリオでのみ検証が必要なケースにおいて、テストの実行フローを制御します。

## 関数呼び出し階層ツリー
```
- checkPlaybackStatus (src/index.ts)
  - escapeHtml (src/index.ts)
    - handlePlayback ()
      - cleanup ()
      - markdownPlugins ()
      - externalResources ()
      - function ()
      - addEventListener ()
- if (src/index.ts)
- blocks (src/index.ts)
- for (src/index.ts)
- catch (src/index.ts)
- media (src/index.ts)

---
Generated at: 2026-01-04 07:02:17 JST
