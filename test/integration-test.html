<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integration Test - synth.init() options parameter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }
        #test-results {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
        }
        .pass {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .fail {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Integration Test: synth.init() options parameter</h1>
    <p>This test verifies that the fix for issue #22 is working correctly.</p>
    
    <div id="test-results">Running tests...</div>

    <!-- Load abcjs from local node_modules -->
    <script src="../node_modules/abcjs/dist/abcjs-basic-min.js"></script>
    
    <script type="module">
        const resultsDiv = document.getElementById('test-results');
        
        function reportResult(passed, message, details = '') {
            resultsDiv.className = passed ? 'pass' : 'fail';
            resultsDiv.innerHTML = `
                <h2>${passed ? '✓ Test PASSED' : '✗ Test FAILED'}</h2>
                <p><strong>${message}</strong></p>
                ${details ? `<pre>${details}</pre>` : ''}
            `;
        }

        async function runTest() {
            try {
                // Check if ABCJS is loaded
                if (typeof ABCJS === 'undefined') {
                    reportResult(false, 'ABCJS library not loaded', 'Make sure abcjs is installed in node_modules');
                    return;
                }

                // Create a simple ABC notation for testing
                const abcNotation = 'X:1\nT:Test\nM:4/4\nL:1/4\nK:C\nC D E F|';
                
                // Render the ABC notation
                const visualObj = ABCJS.renderAbc('test-render', abcNotation, {
                    responsive: 'resize',
                    staffwidth: 600,
                    scale: 1.0
                });

                if (!visualObj || !visualObj[0]) {
                    reportResult(false, 'Failed to render ABC notation', 'visualObj is undefined or empty');
                    return;
                }

                // Create audio context (requires user gesture, but we'll try)
                const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                if (!AudioContextClass) {
                    reportResult(false, 'Web Audio API not supported', 'AudioContext not available in this browser');
                    return;
                }
                
                const audioContext = new AudioContextClass();
                
                // Resume audio context if suspended
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }

                // Create synth
                if (!ABCJS.synth || !ABCJS.synth.CreateSynth) {
                    reportResult(false, 'ABCJS synth API not available', 'CreateSynth not found in ABCJS.synth');
                    return;
                }

                const synth = new ABCJS.synth.CreateSynth();
                
                // Test the fix: Call init with options parameter
                // This is the critical test - if options is missing, it will throw:
                // "TypeError: Cannot read properties of undefined (reading 'swing')"
                try {
                    await synth.init({
                        audioContext: audioContext,
                        visualObj: visualObj[0],
                        options: {}  // This is the fix being tested
                    });
                    
                    reportResult(
                        true, 
                        'synth.init() succeeded with options parameter',
                        'The fix for issue #22 is working correctly.\n' +
                        'synth.init() was called with:\n' +
                        '- audioContext: AudioContext instance\n' +
                        '- visualObj: rendered ABC notation\n' +
                        '- options: {} (prevents undefined property access)\n\n' +
                        'No "Cannot read properties of undefined (reading \'swing\')" error occurred.'
                    );
                } catch (initError) {
                    // Check if it's the specific swing error we're trying to fix
                    if (initError.message && initError.message.includes('swing')) {
                        reportResult(
                            false,
                            'The swing property error still occurs',
                            `Error: ${initError.message}\n\nThis means the fix is not working correctly.`
                        );
                    } else {
                        // Some other error (e.g., network error loading sound fonts)
                        // This is acceptable for this test - we only care about the swing error
                        reportResult(
                            true,
                            'synth.init() did not throw the swing error (other error occurred, which is acceptable)',
                            `Note: A different error occurred, but not the swing property error:\n${initError.message}\n\nThis is acceptable - the important thing is that the swing error is fixed.`
                        );
                    }
                }

            } catch (error) {
                reportResult(false, 'Unexpected error during test', `${error.message}\n\n${error.stack}`);
            }
        }

        // Wait for page to load, then run test
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', runTest);
        } else {
            runTest();
        }
    </script>
    
    <!-- Hidden div for rendering ABC notation -->
    <div id="test-render" style="display: none;"></div>
</body>
</html>
